<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Fidel</title>
<style>
  :root { --bg: #000000; --card: #1c1c1e; --text: #f5f5f7; --accent: #0a84ff; --danger: #ff453a; --input: #2c2c2e; --border: #3a3a3c; --hover: #2c2c2e; --key-bg: #4a4a4c; --key-active: #6a6a6c; }
  * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
  body { background-color: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 16px; transition: padding-bottom 0.2s; }
  header { display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em; background-color: var(--card); border-bottom: 1px solid var(--border); height: 3.5em; flex-shrink: 0; z-index: 20; position: relative; }
  h1 { font-size: 1.2em; font-weight: 600; letter-spacing: -0.02em; }
  .header-actions { display: flex; gap: 0.25em; align-items: center; }
  .icon-btn { background: transparent; color: var(--accent); border: none; padding: 0.5em; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; }
  .icon-btn:hover { background-color: var(--hover); }
  .icon-btn:active { opacity: 0.6; }
  .icon-btn svg { width: 1.5em; height: 1.5em; stroke-width: 2; }
  .icon-btn:disabled { color: var(--border); cursor: default; }
  #menu-dropdown { position: absolute; top: 3.5em; right: 0.5em; background-color: var(--card); border: 1px solid var(--border); border-radius: 0.8em; overflow: hidden; display: none; flex-direction: column; min-width: 200px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 30; }
  #menu-dropdown.visible { display: flex; }
  .menu-item { padding: 0.8em 1em; color: var(--text); background: none; border: none; text-align: left; font-size: 1em; cursor: pointer; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .menu-item:last-child { border-bottom: none; }
  .menu-item:hover { background-color: var(--hover); }
  .menu-item:active { background-color: var(--input); }
  #controls { display: none; gap: 0.5em; padding: 0.5em; background-color: var(--bg); border-bottom: 1px solid var(--border); flex-shrink: 0; overflow-x: auto; animation: slideDown 0.2s ease-out; }
  #controls.visible { display: flex; }
  input { background-color: var(--input); color: var(--text); border: none; padding: 0.5em 1em; border-radius: 0.5em; flex: 1; font-size: 0.9em; min-width: 0; outline: none; font-family: 'abyssinica', 'visual geez unicode', -apple-system, sans-serif; }
  input::placeholder { color: #888; font-family: -apple-system, sans-serif; }
  button.secondary { background: var(--input); color: var(--accent); border: none; padding: 0.4em 1em; border-radius: 0.5em; font-size: 0.9em; font-weight: 500; cursor: pointer; }
  #editor-container { flex-grow: 1; position: relative; display: flex; flex-direction: column; background-color: var(--bg); }
  textarea { flex-grow: 1; width: 100%; background-color: var(--bg); color: var(--text); border: none; padding: 0.75em; resize: none; font-size: 1.1em; line-height: 1.6; outline: none; appearance: none; border-radius: 0; font-family: 'abyssinica', 'visual geez unicode', -apple-system, sans-serif; }
  ::-webkit-scrollbar { width: 0px; background: transparent; }
  @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  #virtual-keyboard { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 0.5em; padding-bottom: max(0.5em, env(safe-area-inset-bottom)); z-index: 50; display: none; flex-direction: column; gap: 0.5em; border-top: 1px solid var(--border); transition: transform 0.2s; }
  #virtual-keyboard.visible { display: flex; animation: slideUp 0.2s ease-out; }
  .kb-row { display: flex; justify-content: center; gap: 0.35em; width: 100%; }
  .key { background: var(--key-bg); color: #fff; border-radius: 0.35em; height: 2em; flex: 1; display: flex; align-items: center; justify-content: center; font-size: 1.3em; cursor: pointer; user-select: none; box-shadow: 0 1px 0 rgba(0,0,0,0.3); transition: background 0.1s; max-width: 10%; font-family: 'abyssinica', 'visual geez unicode', sans-serif; }
  .key:active { background: var(--key-active); transform: translateY(1px); }
  .key.wide { flex: 1.5; max-width: 15%; background: var(--input); font-size: 0.9em; font-family: -apple-system, sans-serif; }
  .key.space { flex: 5; max-width: 50%; font-size: 0.9em; font-family: -apple-system, sans-serif; }
  .key.active-shift { background: var(--accent); color: white; }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
</style>
</head>
<body>

<header>
  <h1>Fidel</h1>
  <div class="header-actions">
    <button class="icon-btn" onclick="undo()" id="btn-undo" title="Undo" disabled>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M9 14L4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>
    </button>
    <button class="icon-btn" onclick="redo()" id="btn-redo" title="Redo" disabled>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14l5-5-5-5"/><path d="M20 9H9.5A5.5 5.5 0 0 0 4 14.5v0A5.5 5.5 0 0 0 9.5 20H13"/></svg>
    </button>
    <button class="icon-btn" onclick="toggleMenu()" title="Menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
  </div>
  
  <div id="menu-dropdown">
    <button class="menu-item" onclick="toggleKeyboard()">Toggle Keyboard</button>
    <button class="menu-item" onclick="copyText()">Copy Text</button>
    <button class="menu-item" onclick="selectAll()">Select All</button>
    <button class="menu-item" onclick="toggleFindReplace()">
      Find & Replace <span id="fr-indicator" style="opacity:0.5">Off</span>
    </button>
  </div>
</header>

<div id="controls">
  <input type="text" id="find-text" placeholder="Find">
  <input type="text" id="replace-text" placeholder="Replace">
  <button class="secondary" onclick="replaceText()">Replace</button>
</div>

<div id="editor-container">
  <textarea id="writing-area" placeholder="Type to transliterate..." spellcheck="false"></textarea>
</div>

<div id="virtual-keyboard">
  <!-- Generated by JS -->
</div>

<script>
  // Transliteration Map
  const replacements = {
    "b": "ብ", "B": "ብ", "ብe": "በ", "ብu": "ቡ", "ብi": "ቢ", "ብa": "ባ", "ቡa": "ቧ", "ቢe": "ቤ", "ብE": "ቤ", "ብo": "ቦ",
    "c": "ች", "ችe": "ቸ", "ችu": "ቹ", "ችi": "ቺ", "ችa": "ቻ", "ቹa": "ቿ", "ቺe": "ቼ", "ችE": "ቼ", "ችo": "ቾ",
    "d": "ድ", "D": "ድ", "ድe": "ደ", "ድu": "ዱ", "ድi": "ዲ", "ድa": "ዳ", "ዱa": "ዷ", "ዲe": "ዴ", "ድE": "ዴ", "ድo": "ዶ",
    "f": "ፍ", "F": "ፍ", "ፍe": "ፈ", "ፍu": "ፉ", "ፍi": "ፊ", "ፍa": "ፋ", "ፉa": "ፏ", "ፊe": "ፌ", "ፍE": "ፌ", "ፍo": "ፎ",
    "g": "ግ", "G": "ግ", "ግe": "ገ", "ግu": "ጉ", "ግi": "ጊ", "ግa": "ጋ", "ጉa": "ጓ", "ጊe": "ጌ", "ግE": "ጌ", "ግo": "ጎ",
    "h": "ህ", "H": "ህ", "ህe": "ኸ", "ህu": "ሁ", "ህi": "ሂ", "ህa": "ሃ", "ሁa": "ኋ", "ሂe": "ሄ", "ህE": "ሄ", "ህo": "ሆ",
    "j": "ጅ", "J": "ጅ", "ጅe": "ጀ", "ጅu": "ጁ", "ጅi": "ጂ", "ጅa": "ጃ", "ጁa": "ጇ", "ጂe": "ጄ", "ጅE": "ጄ", "ጅo": "ጆ",
    "k": "ክ", "K": "ክ", "ክe": "ከ", "ክu": "ኩ", "ክi": "ኪ", "ክa": "ካ", "ኩa": "ኳ", "ኪe": "ኬ", "ክE": "ኬ", "ክo": "ኮ",
    "l": "ል", "L": "ል", "ልe": "ለ", "ልu": "ሉ", "ልi": "ሊ", "ልa": "ላ", "ሉa": "ሏ", "ሊe": "ሌ", "ሊE": "ሌ", "ልo": "ሎ",
    "m": "ም", "M": "ም", "ምe": "መ", "ምu": "ሙ", "ምi": "ሚ", "ምa": "ማ", "ሙa": "ሟ", "ሚe": "ሜ", "ምE": "ሜ", "ምo": "ሞ",
    "n": "ን", "ንe": "ነ", "ንu": "ኑ", "ንi": "ኒ", "ንa": "ና", "ኑa": "ኗ", "ኒe": "ኔ", "ንE": "ኔ", "ንo": "ኖ",
    "p": "ፕ", "ፕe": "ፐ", "ፕu": "ፑ", "ፕi": "ፒ", "ፕa": "ፓ", "ፑa": "ፗ", "ፒe": "ፔ", "ፕE": "ፔ", "ፕo": "ፖ",
    "q": "ቅ", "Q": "ቅ", "ቅe": "ቀ", "ቅu": "ቁ", "ቅi": "ቂ", "ቅa": "ቃ", "ቁa": "ቋ", "ቂe": "ቄ", "ቅE": "ቄ", "ቅo": "ቆ",
    "r": "ር", "R": "ር", "ርe": "ረ", "ርu": "ሩ", "ርi": "ሪ", "ርa": "ራ", "ሩa": "ሯ", "ሪe": "ሬ", "ርE": "ሬ", "ርo": "ሮ",
    "s": "ስ", "ስe": "ሰ", "ስu": "ሱ", "ስi": "ሲ", "ስa": "ሳ", "ሱa": "ሷ", "ሲe": "ሴ", "ስE": "ሴ", "ስo": "ሶ",
    "t": "ት", "ትe": "ተ", "ትu": "ቱ", "ትi": "ቲ", "ትa": "ታ", "ቱa": "ቷ", "ቲe": "ቴ", "ትE": "ቴ", "ትo": "ቶ",
    "v": "ቭ", "V": "ቭ", "ቭe": "ቨ", "ቭu": "ቩ", "ቭi": "ቪ", "ቭa": "ቫ", "ቩa": "ቯ", "ቪe": "ቬ", "ቭE": "ቬ", "ቭo": "ቮ",
    "w": "ው", "W": "ው", "ውe": "ወ", "ውu": "ዉ", "ውi": "ዊ", "ውa": "ዋ", "ዊe": "ዌ", "ውE": "ዌ", "ውo": "ዎ",
    "x": "ሽ", "X": "ሽ", "ሽe": "ሸ", "ሽu": "ሹ", "ሽi": "ሺ", "ሽa": "ሻ", "ሹa": "ሿ", "ሺe": "ሼ", "ሽE": "ሼ", "ሽo": "ሾ",
    "y": "ይ", "Y": "ይ", "ይe": "የ", "ይu": "ዩ", "ይi": "ዪ", "ይa": "ያ", "ዪe": "ዬ", "ይE": "ዬ", "ይo": "ዮ",
    "z": "ዝ", "ዝe": "ዘ", "ዝu": "ዙ", "ዝi": "ዚ", "ዝa": "ዛ", "ዙa": "ዟ", "ዚe": "ዜ", "ዝE": "ዜ", "ዝo": "ዞ",
    "C": "ጭ", "ጭe": "ጨ", "ጭu": "ጩ", "ጭi": "ጪ", "ጭa": "ጫ", "ጩa": "ጯ", "ጪe": "ጬ", "ጭE": "ጬ", "ጭo": "ጮ",
    "N": "ኝ", "ኝe": "ኘ", "ኝu": "ኙ", "ኝi": "ኚ", "ኝa": "ኛ", "ኙa": "ኟ", "ኚe": "ኜ", "ኝE": "ኜ", "ኝo": "ኞ",
    "P": "ጵ", "ጵe": "ጰ", "ጵu": "ጱ", "ጵi": "ጲ", "ጵa": "ጳ", "ጱa": "ጷ", "ጲe": "ጴ", "ጵE": "ጴ", "ጵo": "ጶ",
    "S": "ፅ", "ፅe": "ፀ", "ፅu": "ፁ", "ፅi": "ፂ", "ፅa": "ፃ", "ፁa": "ጿ", "ፂe": "ፄ", "ፅE": "ፄ", "ፅo": "ፆ",
    "T": "ጥ", "ጥe": "ጠ", "ጥu": "ጡ", "ጥi": "ጢ", "ጥa": "ጣ", "ጡa": "ጧ", "ጢe": "ጤ", "ጥE": "ጤ", "ጥo": "ጦ",
    "Z": "ዥ", "ዥe": "ዠ", "ዥu": "ዡ", "ዥi": "ዢ", "ዥa": "ዣ", "ዡa": "ዧ", "ዢe": "ዤ", "ዥE": "ዤ", "ዥo": "ዦ",
    "እe": "ኧ", "ኢe": "ኤ", "a": "አ", "A": "አ", "u": "ኡ", "U": "ኡ", "i": "ኢ", "I": "ኢ", "E": "ኤ", "o": "ኦ", "O": "ኦ", "e": "እ",
    "'": "'", "''": "\"", "'እ": "እ", "'ኡ": "ኡ", "'ኢ": "ኢ", "'አ": "አ", "'ኢe": "ኤ", "'ኤ": "ኤ", "'ኦ": "ኦ", "'እe": "ኧ",
    "እግዚአብሄር": "እግዚአብሔር", "እግዚ/ር": "እግዚአብሔር ", "እየሱስ": "ኢየሱስ", "እረ ": "ኧረ ", "እየሩሳሌም": "ኢየሩሳሌም", "እያሱ": "ኢያሱ", "አእምሮ": "አይምሮ", "ራሔል": "ራሄል", "ቤተልሔም": "ቤተልሔም",
    "ሐ": "ሃ", "ሑ": "ሁ", "ሒ": "ሂ", "ሕ": "ህ", "ሖ": "ሆ", "ኀ": "ሃ", "ኃ": "ሃ", "ኅ": "ህ", "ሠ": "ሰ", "ሡ": "ሱ", "ሢ": "ሲ", "ሣ": "ሳ", "ሤ": "ሴ", "ሥ": "ስ", "ሦ": "ሶ", "ኣ": "አ", "ቍ": "ቁ", "ቈ": "ቆ", "ኵ": "ኩ", "ኻ": "ሃ", "ኾ": "ሆ", "ጕ": "ጉ", "ኆ": "ሆ", "ኰ": "ኮ", "ኹ": "ሁ", "ኼ": "ሄ", "ኽ": "ህ", "ጐ": "ጎ", "ጸ": "ፀ", "ጹ": "ፁ", "ጺ": "ፂ", "ጻ": "ፃ", "ጼ": "ፄ", "ጽ": "ፅ", "ጾ": "ፆ", "ዐ": "አ", "ዑ": "ኡ", "ዒ": "ኢ", "ዓ": "አ", "ዔ": "ኤ", "ዕ": "እ", "ዖ": "ኦ", ";": "፤", "',": "፥", "፥,": "፣", ":": "፡", "።": "።"
  };

  // State Management
  const history = [""];
  let historyIndex = 0;
  let saveTimeout;
  const STORAGE_KEY = 'fidel_content';
  let isShifted = false;

  // Load from LocalStorage on boot
  const loadSavedContent = () => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      document.getElementById("writing-area").value = saved;
      history[0] = saved; // Init history with saved content
    }
  };
  
  const toAmharic = (text) => {
    let tv = text;
    for (const [key, value] of Object.entries(replacements)) {
      tv = tv.split(key).join(value); 
    }
    return tv;
  };

  const updateHistory = (val) => {
    if (val === history[historyIndex]) return;
    historyIndex++;
    history.length = historyIndex; // truncate redo history
    history.push(val);
    updateUndoRedoButtons();
  };

  const updateUndoRedoButtons = () => {
    document.getElementById('btn-undo').disabled = historyIndex <= 0;
    document.getElementById('btn-redo').disabled = historyIndex >= history.length - 1;
  };

  const undo = () => {
    if (historyIndex > 0) {
      historyIndex--;
      const val = history[historyIndex];
      document.getElementById("writing-area").value = val;
      localStorage.setItem(STORAGE_KEY, val); // Sync storage on undo
      updateUndoRedoButtons();
    }
  };

  const redo = () => {
    if (historyIndex < history.length - 1) {
      historyIndex++;
      const val = history[historyIndex];
      document.getElementById("writing-area").value = val;
      localStorage.setItem(STORAGE_KEY, val); // Sync storage on redo
      updateUndoRedoButtons();
    }
  };

  // Core transliteration logic to be used by all inputs
  const processTransliteration = (e) => {
    if (e.ctrlKey || e.metaKey || e.altKey) return false;
    
    const el = e.target;
    const start = el.selectionStart;
    const end = el.selectionEnd;
    const original = el.value;
    const newVal = toAmharic(original);
    
    if (newVal !== original) {
      const diff = newVal.length - original.length;
      el.value = newVal;
      el.setSelectionRange(start + diff, end + diff);
      return true; // Indicates change happened
    }
    return false;
  };

  // Main editor handler: Transliterate + Save + History
  const handleMainInput = (e) => {
    processTransliteration(e);
    
    const val = e.target.value;
    localStorage.setItem(STORAGE_KEY, val);

    // Debounce history save
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => updateHistory(val), 400);
  };

  // Aux input handler (Find/Replace): Transliterate only
  const handleAuxInput = (e) => {
    processTransliteration(e);
  };

  const toggleMenu = () => {
    document.getElementById("menu-dropdown").classList.toggle("visible");
  };

  const toggleFindReplace = () => {
    const controls = document.getElementById("controls");
    controls.classList.toggle("visible");
    const isVisible = controls.classList.contains("visible");
    document.getElementById("fr-indicator").innerText = isVisible ? "On" : "Off";
    document.getElementById("fr-indicator").style.opacity = isVisible ? "1" : "0.5";
    document.getElementById("fr-indicator").style.color = isVisible ? "var(--accent)" : "inherit";
    toggleMenu();
  };

  const copyText = () => {
    const txt = document.getElementById("writing-area");
    txt.select();
    txt.setSelectionRange(0, 99999);
    document.execCommand("copy");
    toggleMenu();
  };

  const selectAll = () => {
    document.getElementById("writing-area").select();
    toggleMenu();
  };

  const replaceText = () => {
    const find = document.getElementById("find-text").value;
    const replace = document.getElementById("replace-text").value;
    const area = document.getElementById("writing-area");
    if (!find) return;
    const newVal = area.value.split(find).join(replace);
    area.value = newVal;
    localStorage.setItem(STORAGE_KEY, newVal);
    updateHistory(newVal);
  };

  // Virtual Keyboard Logic
  const toggleKeyboard = () => {
    const kb = document.getElementById("virtual-keyboard");
    const isVisible = kb.classList.contains("visible");
    
    if (isVisible) {
      kb.classList.remove("visible");
      document.body.style.paddingBottom = "0";
    } else {
      kb.classList.add("visible");
      // Estimate keyboard height ~ 220px
      document.body.style.paddingBottom = "220px";
      renderKeyboard();
    }
    document.getElementById("menu-dropdown").classList.remove("visible");
  };

  const insertChar = (char) => {
    const el = document.getElementById("writing-area");
    el.focus();
    const start = el.selectionStart;
    const end = el.selectionEnd;
    const text = el.value;
    
    // Insert raw char
    const newText = text.substring(0, start) + char + text.substring(end);
    el.value = newText;
    el.setSelectionRange(start + 1, start + 1);

    // Trigger existing transliteration logic
    const mockEvent = { target: el, preventDefault: () => {} };
    handleMainInput(mockEvent);
    
    // Auto unshift after char unless caps lock (not imp here)
    if (isShifted) toggleShift();
  };

  const handleBackspace = () => {
    const el = document.getElementById("writing-area");
    el.focus();
    const start = el.selectionStart;
    const end = el.selectionEnd;
    const text = el.value;

    if (start === end && start > 0) {
      el.value = text.substring(0, start - 1) + text.substring(end);
      el.setSelectionRange(start - 1, start - 1);
    } else if (start !== end) {
      el.value = text.substring(0, start) + text.substring(end);
      el.setSelectionRange(start, start);
    }
    handleMainInput({ target: el });
  };

  const toggleShift = () => {
    isShifted = !isShifted;
    renderKeyboard();
  };

  const renderKeyboard = () => {
    const kb = document.getElementById("virtual-keyboard");
    const rows = [
      ['q','w','e','r','t','y','u','i','o','p'],
      ['a','s','d','f','g','h','j','k','l'],
      ['shift', 'z','x','c','v','b','n','m', 'backspace'],
      ['123', 'space', 'enter']
    ];
    
    let html = '';
    
    rows.forEach((row, idx) => {
      html += '<div class="kb-row">';
      row.forEach(key => {
        let label = key;
        let actionKey = isShifted ? key.toUpperCase() : key;
        let action = `insertChar('${actionKey}')`;
        let cls = 'key';

        // Handle special keys
        if (key === 'shift') {
          label = isShifted ? '⬆' : '⇧';
          action = 'toggleShift()';
          cls += ' wide ' + (isShifted ? 'active-shift' : '');
        } else if (key === 'backspace') {
          label = '⌫';
          action = 'handleBackspace()';
          cls += ' wide';
        } else if (key === 'space') {
          label = 'Space';
          action = "insertChar(' ')";
          cls += ' space';
        } else if (key === 'enter') {
          label = 'return';
          action = "insertChar('\\n')";
          cls += ' wide';
        } else if (key === '123') {
           label = '123';
           action = ''; // Placeholder
           cls += ' wide';
        } else {
          // Standard keys: Lookup Amharic label
          if (replacements[actionKey]) {
            label = replacements[actionKey];
          } else {
             label = actionKey;
          }
        }

        html += `<div class="${cls}" onclick="${action}">${label}</div>`;
      });
      html += '</div>';
    });

    kb.innerHTML = html;
  };

  // Event Listeners
  document.getElementById("writing-area").addEventListener('keyup', handleMainInput);
  document.getElementById("find-text").addEventListener('keyup', handleAuxInput);
  document.getElementById("replace-text").addEventListener('keyup', handleAuxInput);
  
  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('header') && !e.target.closest('#menu-dropdown')) {
      document.getElementById("menu-dropdown").classList.remove("visible");
    }
  });

  // Init
  loadSavedContent();
  renderKeyboard(); // Pre-render hidden state

  if ("serviceWorker" in navigator && !navigator.serviceWorker.controller) {
    navigator.serviceWorker.register("pwabuilder-sw.js", { scope: "./" });
  }
</script>
</body>
</html>
